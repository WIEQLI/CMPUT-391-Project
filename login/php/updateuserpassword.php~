<?php

//Inserts general functions
require('/compsci/webdocs/kjross/web_docs/usermanagement/php/processfield.php');
require('/compsci/webdocs/kjross/web_docs/usermanagement/php/checkfieldlength.php');
require('/compsci/webdocs/kjross/web_docs/usermanagement/php/checkfieldempty.php');

//Create errorcode array that hold status of errors and messages
$errorcode = array(true,'');

//Processes fields text
$password = processField($_POST['password']);
$password2 = processField($_POST['password2']);

//Checks that fields arent empty
$errorcode = checkFieldEmpty($password,'Please enter your password<br/>',$errorcode);
$errorcode = checkFieldEmpty($password2,'Please enter your password<br/>',$errorcode);

//Checks that fields are appropriate size
$errorcode = checkFieldLength(24,$password,"Please enter an password with less then 24 characters <br/>",$errorcode);
$errorcode = checkFieldLength(24,$password2,"Please enter an password with less then 24 characters <br/>",$errorcode);

if($password != $password2) {
	$errorcode[1] = 'passwords are not the same. Please re-enter and make sure they are the same.';
	$errorcode[0] = false;
}

//If passes all checks
if($errorcode[0]) {
	require('/compsci/webdocs/kjross/web_docs/database/dbconnect.php');
	require('/compsci/webdocs/kjross/web_docs/database/executecommand.php');

	//Establish connection to database
	$conn = dbConnect();

	//Checks password exists in persons
	$errorcode = checkpasswordExists($conn,$password,$errorcode);

	if($errorcode[0]) {
		//Gets next person_id in persons table
		$id = getPersonId($conn,$password);

		//Starts sessions
		session_start();

		//SQL command for entering values into persons
		$sql = 'UPDATE users SET person_id = \''.$id.'\' WHERE user_name = \''.$_SESSION['user_name'].'\''; 

		//Executes sql command
		$num = executeCommand($conn,$sql);

		//Closes connection
		oci_close($conn);
	
		if($num[1]) {
			//Returns status of .php code and messages
			echo json_encode(array('status'=>true,'message'=>'Users password updated sucessfully updated to '.$password));
			
		}
		else {
			//Returns status of .php code and messages
			echo json_encode(array('status'=>false,'message'=>'Error executing command to database'));
			
		}
	}
	else {
		//Closes connection
		oci_close($conn);
	
		//Returns status of .php code and messages
		echo json_encode(array('status'=>$errorcode[0],'message'=>$errorcode[1]));
	}	
}
else {
	//Returns status of .php code and messages
	echo json_encode(array('status'=>$errorcode[0],'message'=>$errorcode[1]));
}

//Checks if password provided exists in persons
function checkpasswordExists($conn,$password,$errorcode) {
	//Executes sql command
	$num = executeCommand($conn,'SELECT COUNT(*) from persons p where p.password =\''.$password.'\'');

	//If oci_parse doesnt find password within persons
	if($num[0][0] == 0) {
		$errorcode[1] = 'Person doesnt exist with that password. Insert new password or create person with that password.';
		$errorcode[0] = false;	
	}
	return $errorcode;
}

//Gets person_id from persons table that corresponds with password
function getPersonId($conn,$password){

	//Executes sql command
	$num = executeCommand($conn,'SELECT p.person_id from persons p where p.password =\''.$password.'\'');

	//Returns person_id from persons
	return $num[0][0];
}

?>
